{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 mb-5">
  <div class="row">
    <div class="col-md-6">
      <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}" class="img-fluid">
    </div>
    <div class="col-md-6">
      <h1>{{ movie.title }}</h1>
      <!-- Average Rating -->
      <p class="fs-5">
        {% if average_rating %}
          <span>⭐ {{ average_rating|floatformat:1 }}/10</span>
        {% else %}
          <span class="text-muted">No ratings yet</span>
        {% endif %}
      </p>

      <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
      <p><strong>Genres:</strong> {{ movie_genres|join:", " }}</p>
      <p>{{ movie.overview }}</p>

      <h5 class="mt-4 mb-2">Reviews</h5>
        {% for review in reviews %}
        <div class="border rounded p-2 mb-2 review-container">
            <div class="d-flex justify-content-between align-items-center">
              <strong class="username">{{ review.user.username }}</strong>
              <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
            </div>
            <div class="rating">
              ⭐ {{review.rating}}/10
            </div>
            <p class="review-text mt-1">{{ review.text }}</p>

            <!-- Delete Button -->
            {% if user == review.user %}
            <form method="post" action="{% url 'movies:delete_review' review.id %}" class="delete-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
            {% endif %}
        </div>
      {% empty %}
        <p>No reviews yet. Be the first to review this movie!</p>
      {% endfor %}

      {% if user.is_authenticated %}
        <h6 class="mt-4">Write a Review</h6>
        <form method="post" action="{% url 'movies:submit_review' movie.id %}" class="review-form">
          {% csrf_token %}

          <div class="mt-0 mb-1">
            <div id="star-rating">
              {% for i in star_range %}
                <span class="star" data-value="{{ i }}">&#9733;</span>
              {% endfor %}
            </div>
            {{ form.rating }}
          </div>

          <div class="mb-1 r-4">
            {{ form.text }}
          </div>

          <button type="submit" class="btn btn-primary mt-2">Submit</button>
        </form>
      {% else %}
        <p><a href="{% url 'users:login' %}">Log in</a> to write a review.</p>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .review-container {
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
    white-space: normal;
    padding-left: 12px !important;
  }

  .rating {
      margin-left: -3px;
  }

  .review-form {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 8px;
  }

  #star-rating {
    margin-top: -10px;
    font-size: 1.7rem;
    cursor: pointer;
    display: flex;
    gap: 3px;
  }

  .star {
    color: #ccc;
    transition: color 0.2s;
  }

  .star.selected {
    color: gold;
  }

  .star.hovered {
    color: gold;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const stars = document.querySelectorAll("#star-rating .star");
    const ratingInput = document.getElementById("id_rating");
    let selectedRating = 0; // Store the selected rating

    stars.forEach(star => {
      star.addEventListener("mouseover", function() {
        resetStars();
        this.classList.add("hovered");
        let prev = this.previousElementSibling;
        while (prev) {
          prev.classList.add("hovered");
          prev = prev.previousElementSibling;
        }
      });

      star.addEventListener("mouseleave", function() {
        resetStars();
        applySelectedRating(); // Reapply selected rating after hover
      });

      star.addEventListener("click", function() {
       selectedRating = parseInt(this.getAttribute("data-value")); // Store selected rating
        ratingInput.value = selectedRating;
        applySelectedRating();
      });
    });

    function resetStars() {
      stars.forEach(s => s.classList.remove("hovered", "selected"));
    }

    function applySelectedRating() {
      stars.forEach(s => {
        if (s.getAttribute("data-value") <= selectedRating) {
          s.classList.add("selected");
        }
      });
    }
  });
</script>

{% endblock content %}
